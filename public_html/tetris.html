<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body id ="all" style="background-color: beige;">
        <div id="tetris" style="margin-left: 35%; font-size: 30px; line-height: 1px;"></div>
        <div id="result" style="margin-left: 15%; margin-top: -35%; font-family: Courier New;
             border-style: double; border-color: red; padding: 0.5rem; border-width: 0.5rem;
             width: 150px;"></div>
        <div id="lvl" style="margin-left: 15%; margin-top: 5%; font-family: Courier New;
             border-style: double; border-color: red; padding: 0.5rem; border-width: 0.5rem;
             width: 150px;"></div>
        <div id="resultMax" style="margin-left: 15%; margin-top: 5%; font-family: Courier New;
             border-style: double; border-color: red; padding: 0.5rem; border-width: 0.5rem;
             width: 150px;">Puntuació Màxima: </div>
        <div id="piezaActual" style="margin-left: 60%; margin-top: -22%; font-family: Courier New; font-size: 20px;
             line-height: 1px;"></div>
        <div id="piezaSig" style="margin-left:  60%; margin-top: 10.5%; font-family: Courier New; font-size: 20px;
             line-height: 1px;"></div>

    </body>
    <script>
        //objecte joc
        var joc = {
            mapa: [
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],
            estat: 0,
            puntuacio: 0,
            puntMax: (localStorage.getItem("max" == undefined ? 0 : localStorage.getItem("max"))),

            pecaV: {},
            pecaS: {},
            contPeces: 0,
            cont: [0, 0, 0, 0, 0, 0, 0],
            intervalT: 0,
            inicializar: function () {
                var piezaA = GeneraPecaAleatoria();
                this.pecaV = new pieza(piezaA[0], piezaA[1], 0, 3);
                piezaA = GeneraPecaAleatoria();
                this.pecaS = new pieza(piezaA[0], piezaA[1], 0, 3);
            },
            pintarJoc: function () {
                var resultat = "";
                for (var i = 0; i < this.mapa.length; i++)
                {
                    resultat += "<br>";
                    for (var j = 0; j < this.mapa[i].length; j++)
                    {
                        if (this.mapa[i][j] == 1) {
                            resultat = resultat + "<img src='verde.jpg' height='24px' width='25px'>";
                        } else if (this.mapa[i][j] == 11) {
                            resultat = resultat + "<img src='gris.jpg' height='24px' width='25px'>";
                        } else {
                            resultat = resultat + "<img src='azul.jpg' height='24px' width='25px'>";
                        }
                    }
                }
                document.getElementById("tetris").innerHTML = resultat;
            },
            interaccioTeclat: function () {
                function notificaObservador(e) {
                    var direccion = 0;
                    if (e.code == "ArrowRight") {
                        direccion = 1;
                    } else if (e.code == "ArrowLeft") {
                        direccion = 2;
                    } else if (e.code == "ArrowUp") {
                        direccion = 3;
                    } else if (e.code == "ArrowDown") {
                        direccion = 4;
                    }

                    switch (direccion) {
                        case 1:
                            joc.pecaV.moureDreta();
                            for (var i = joc.mapa.length - 1; i >= 0; i--)
                            {
                                for (var j = joc.mapa[i].length - 1; j >= 0; j--)
                                {
                                    if (joc.mapa[i][j] === 1) {
                                        joc.mapa[i][j] = 0;
                                    }
                                }
                            }
                            if (!joc.posicioCorrecta()) {
                                joc.pecaV.moureEsq();
                                joc.pecaV.pintar();
                            } else {
                                joc.pecaV.pintar();
                            }
                            break;
                        case 2:
                            joc.pecaV.moureEsq();
                            for (var i = joc.mapa.length - 1; i >= 0; i--)
                            {
                                for (var j = joc.mapa[i].length - 1; j >= 0; j--)
                                {
                                    if (joc.mapa[i][j] === 1) {
                                        joc.mapa[i][j] = 0;
                                    }
                                }
                            }
                            if (!joc.posicioCorrecta()) {
                                joc.pecaV.moureDreta();
                                joc.pecaV.pintar();
                            } else {
                                joc.pecaV.pintar();
                            }
                            break;
                        case 3:
                            joc.pecaV.rotarDreta();
                            for (var i = joc.mapa.length - 1; i >= 0; i--)
                            {
                                for (var j = joc.mapa[i].length - 1; j >= 0; j--)
                                {
                                    if (joc.mapa[i][j] === 1) {
                                        joc.mapa[i][j] = 0;
                                    }
                                }
                            }
                            if (!joc.posicioCorrecta()) {
                                joc.pecaV.rotarEsq();
                                joc.pecaV.pintar();
                            } else {
                                joc.pecaV.pintar();
                            }
                            break;
                        case 4:
                            joc.pecaV.moureAvall();
                            for (var i = joc.mapa.length - 1; i >= 0; i--)
                            {
                                for (var j = joc.mapa[i].length - 1; j >= 0; j--)
                                {
                                    if (joc.mapa[i][j] === 1) {
                                        joc.mapa[i][j] = 0;
                                    }
                                }
                            }
                            if (!joc.posicioCorrecta()) {
                                joc.pecaV.moureAdalt();
                                joc.pecaV.pintar();
                            } else {
                                joc.pecaV.pintar();
                                joc.puntuacio = joc.puntuacio + 1;
                            }
                            break;
                    }
                }

                var element = document.getElementById("all");
                element.addEventListener("keydown", notificaObservador);
            },
            posicioCorrecta: function () {
                for (var i = 0; i < this.pecaV.forma.length; i++) {
                    for (var j = 0; j < this.pecaV.forma[i].length; j++) {
                        if (this.pecaV.forma[i][j] != 0) {
                            if (this.pecaV.x + i < 0 || this.pecaV.x + i > 24) {
                                return false;
                            }
                            if (this.pecaV.y + j < 0 || this.pecaV.y + j > 9) {
                                return false;
                            }
                            if (this.mapa[this.pecaV.x + i][this.pecaV.y + j] != 0) {
                                return false;
                            }
                        }
                    }
                }
                return true;
            },
            movAuto: function () {
                this.pecaV.moureAvall();
                for (var i = this.mapa.length - 1; i >= 0; i--)
                {
                    for (var j = this.mapa[i].length - 1; j >= 0; j--)
                    {
                        if (this.mapa[i][j] === 1) {
                            this.mapa[i][j] = 0;
                        }
                    }
                }
                if (!this.posicioCorrecta()) {
                    this.pecaV.moureAdalt();
                    this.pecaV.pintar();
                    this.pecaV = this.pecaS;
                    var piezaA = GeneraPecaAleatoria();
                    this.pecaS = new pieza(piezaA[0], piezaA[1], 0, 3);
                    //Para cambiar el valor de la pieza al llegar abajo
                    for (var i = this.mapa.length - 1; i >= 0; i--) {
                        for (var j = this.mapa[i].length - 1; j >= 0; j--) {
                            if (this.mapa[i][j] === 1) {
                                this.mapa[i][j] = 11;
                            }
                        }
                    }
                    this.puntuacio = this.puntuacio + 10;
                    this.contPeces++;
                    if(this.contPeces % 10 == 0){
                        this.estat = this.estat + 1;
                    }
                } else {
                    this.pecaV.pintar();
                }
            }

        };
        //__________________FUNCION QUE GENERA UNA PIEZA ALEATORIA, DEVUELVE UN ARRAY CON LA FORMA Y EL COLOR
        function GeneraPecaAleatoria()
        {
            var peces = [
                [[[0, 0, 0, 0], [0, 1, 1, 0], [0, 1, 1, 0], [0, 0, 0, 0]], "groc"],
                [[[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0]], "lila"],
                [[[0, 0, 0, 0], [0, 1, 1, 0], [1, 1, 0, 0], [0, 0, 0, 0]], "verd"],
                [[[0, 0, 0, 0], [0, 1, 1, 0], [0, 0, 1, 1], [0, 0, 0, 0]], "roig"],
                [[[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 1, 0], [0, 0, 0, 0]], "blau"],
                [[[0, 1, 1, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 0, 0, 0]], "taronga"],
                [[[0, 0, 0, 0], [1, 1, 1, 0], [0, 1, 0, 0], [0, 0, 0, 0]], "morat"]];
            var numeroAleatori = Math.round(Math.random() * 6);
            return peces[numeroAleatori];
        }
        // GeneraPecaAleatoria() devuelve array de 2 posiciones, pos 1 -> forma, pos 2 -> color
        //var genPieza = GeneraPecaAleatoria();

        //____________________________________Objeto pieza________________________________________________
        var pieza = function (forma, color, x, y)
        {
            this.forma = forma;
            this.color = color;
            this.x = x;
            this.y = y;
        };
        //LA PIEZA SE CREARIA ASÍ----> 
        //var p = new pieza(genPieza[0], genPieza[1], 0, 3);
        //console.log(p);

        //_________________________FUNCIONES DEL OBJETO PIEZA____________________________________________________
        //
        //__________________________FUNCION PARA VER LA PIEZA EN EL MAPA
        pieza.prototype.pintar = function ()
        {
            for (var i = 0; i < this.forma.length; i++)
            {
                for (var j = 0; j < this.forma[i].length; j++)
                {
                    if (this.forma[i][j] == 1) {
                        joc.mapa[(this.x + i)][(this.y + j)] = 1;
                    }
                }
            }
        };
        //__________________________FUNCION PARA VER LA PIEZA ACTUAL Y SIGUIENTE
        pieza.prototype.pintarPeca = function ()
        {
            var resultat = "";
            for (var i = 0; i < this.forma.length; i++)
            {
                resultat += "<br>";
                for (var j = 0; j < this.forma[i].length; j++)
                {
                    if (this.forma[i][j] == 1) {
                        resultat = resultat + "<img src='verde.jpg' height='25px' width='25px'>";
                    } else {
                        resultat = resultat + "<img src='azul.jpg' height='25px' width='25px'>";
                    }
                }
            }
            return resultat;
        };

        //______________FUNCION PARA ROTAR A LA DERECHA_________________________
        pieza.prototype.rotarDreta = function () {
            var formaNova = new Array();
            for (var i = 0; i < this.forma.length; i++) {
                formaNova[i] = new Array();
                for (var j = 0; j < this.forma[i].length; j++) {
                    formaNova[i][j] = this.forma[this.forma[i].length - 1 - j][i];
                }
            }
            this.forma = formaNova;
        };
        
        //______________FUNCION PARA ROTAR A LA DERECHA_________________________
        pieza.prototype.rotarDreta = function () {
            var formaNova = new Array();
            for (var i = 0; i < this.forma.length; i++) {
                formaNova[i] = new Array();
                for (var j = 0; j < this.forma[i].length; j++) {
                    formaNova[i][j] = this.forma[this.forma[i].length - 1 - j][i];
                }
            }
            this.forma = formaNova;
        };
        //______________FUNCION PARA ROTAR A LA IZQUIERDA_________________________
        pieza.prototype.rotarEsq = function () {
            joc.pecaV.rotarDreta();
            joc.pecaV.rotarDreta();
            joc.pecaV.rotarDreta();
        };
        //___________FUNCION PARA MOVER A LA IZQUIERDA
        pieza.prototype.moureEsq = function () {
            if ((this.y - 1) > -2) {
                this.y--;
            }
        };

        //_____________FUNCION PARA MOVER A LA DERECHA
        pieza.prototype.moureDreta = function () {
            if ((this.y + 1) < 9) {
                this.y++;
            }
        };

        //____________FUNCION PARA MOVER LA PIEZA HACIA ABAJO
        pieza.prototype.moureAvall = function () {
            if ((this.x + 1) <= 25) {
                this.x++;
            }
        };
        //____________FUNCION PARA MOVER LA PIEZA HACIA ARRIBA
        pieza.prototype.moureAdalt = function () {
            if ((this.x - 1) >= 0) {
                this.x--;
            }
        };

        joc.inicializar();
        joc.pecaV.pintar();
        joc.pintarJoc();
        joc.interaccioTeclat();

        document.getElementById("piezaActual").innerHTML = joc.pecaV.pintarPeca();
        document.getElementById("piezaSig").innerHTML = joc.pecaS.pintarPeca();
        document.getElementById("result").innerHTML = "Puntuació: " + joc.puntuacio;
        document.getElementById("lvl").innerHTML = "Nivell: " + joc.estat;

        var a = setInterval(function () {
            joc.pintarJoc();
            joc.movAuto();
            document.getElementById("piezaActual").innerHTML = joc.pecaV.pintarPeca();
            document.getElementById("piezaSig").innerHTML = joc.pecaS.pintarPeca();
            document.getElementById("result").innerHTML = "Puntuació: " + joc.puntuacio;
            document.getElementById("lvl").innerHTML = "Nivell: " + joc.estat;
        }
        , 500);
    </script>
</html>
